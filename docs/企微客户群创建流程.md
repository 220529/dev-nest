# 企微客户群创建流程 - 开发文档

## 1. 需求背景

### 1.1 业务需求

当客户到店后，我们希望将对应的服务人员（设计师、项目经理等）一并邀请至同一个企微群中，以便后续更好地进行客户维护与管理。

### 1.2 当前问题

- 设计师通常添加的是客户的**个人微信**，拉的是**普通微信群**
- 一旦员工离职，很容易导致**客户流失**
- 无法统一管理和追踪客户服务记录

### 1.3 解决方案

通过企微的**客户群**功能，实现：
- 客户群归企业所有，员工离职不丢客
- 统一管理客户服务记录
- 通过ERP系统自动创建客户群

## 2. 技术方案

### 2.1 整体流程

```
H5页面点击按钮
  ↓
获取订单信息（订单ID）
  ↓
获取设计师企微ID（根据订单ID）
  ↓
获取设计师的外部联系人列表（通过企微API）
  ↓
根据订单关联的个护手机号，匹配外部联系人
  ↓
获取项目经理企微ID（根据订单ID）
  ↓
创建企微客户群（设计师、客户、项目经理）
```

### 2.2 技术选型

- **前端**：H5页面（在企微客户端内打开）
- **后端**：ERP系统（t1-code项目）
- **企微API**：JS-SDK + 服务端API
- **转发服务**：dev-nest项目（转发API请求）

## 3. 实现步骤

### 3.1 后端接口设计

#### 3.1.1 获取订单信息接口

**接口路径**：`/api/runFlow`

**请求参数**：
```json
{
  "flowId": "订单信息查询流程ID",
  "orderId": "订单ID"
}
```

**返回数据**：
```json
{
  "code": 1,
  "data": {
    "orderId": "订单ID",
    "designerWxUserId": "设计师企微ID",
    "projectManagerWxUserId": "项目经理企微ID",
    "customerPhone": "客户手机号（个护）"
  }
}
```

#### 3.1.2 获取设计师的外部联系人列表

**接口路径**：`/api/runFlow`

**请求参数**：
```json
{
  "flowId": "获取外部联系人列表流程ID",
  "wxUserId": "设计师企微ID"
}
```

**返回数据**：
```json
{
  "code": 1,
  "data": {
    "externalContacts": [
      {
        "externalUserId": "外部联系人ID",
        "name": "客户姓名",
        "phone": "手机号",
        "avatar": "头像URL"
      }
    ]
  }
}
```

#### 3.1.3 匹配客户并创建群聊

**接口路径**：`/api/runFlow`

**请求参数**：
```json
{
  "flowId": "创建客户群流程ID",
  "orderId": "订单ID",
  "designerWxUserId": "设计师企微ID",
  "projectManagerWxUserId": "项目经理企微ID",
  "customerExternalUserId": "客户外部联系人ID"
}
```

**返回数据**：
```json
{
  "code": 1,
  "data": {
    "chatId": "群聊ID",
    "groupName": "群名称",
    "success": true
  }
}
```

### 3.2 前端页面实现

#### 3.2.1 页面结构

创建页面：`public/create-customer-group.html`

**功能模块**：
1. 订单信息展示
2. 客户匹配确认
3. 创建群聊按钮
4. 操作结果反馈

#### 3.2.2 核心流程代码

```javascript
// 1. 获取订单信息
async function getOrderInfo(orderId) {
  const res = await fetch('/api/runFlow', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      flowId: '订单信息查询流程ID',
      orderId: orderId
    })
  });
  return await res.json();
}

// 2. 获取设计师的外部联系人列表
async function getExternalContacts(wxUserId) {
  const res = await fetch('/api/runFlow', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      flowId: '获取外部联系人列表流程ID',
      wxUserId: wxUserId
    })
  });
  return await res.json();
}

// 3. 根据手机号匹配客户
function matchCustomer(contacts, phone) {
  return contacts.find(contact => 
    contact.phone === phone || 
    contact.phone === phone.replace(/\s+/g, '')
  );
}

// 4. 创建客户群（通过JS-SDK）
function createCustomerGroup(externalUserIds, staffUserIds, groupName) {
  const userlist = [...externalUserIds, ...staffUserIds].join('|');
  
  wx.invoke('openEnterpriseChat', {
    userlist: userlist,
    groupName: groupName,
    success: function(res) {
      console.log('创建群聊成功', res);
      // 调用后端接口记录群信息
      recordGroupInfo(res);
    },
    fail: function(err) {
      console.error('创建群聊失败', err);
    }
  });
}

// 5. 记录群信息到数据库
async function recordGroupInfo(groupInfo) {
  await fetch('/api/runFlow', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      flowId: '记录群信息流程ID',
      orderId: orderId,
      chatId: groupInfo.chatId,
      groupName: groupInfo.groupName
    })
  });
}
```

### 3.3 完整流程实现

```javascript
// 主流程
async function createCustomerGroupFlow(orderId) {
  try {
    // 1. 获取订单信息
    const orderInfo = await getOrderInfo(orderId);
    const { designerWxUserId, projectManagerWxUserId, customerPhone } = orderInfo.data;
    
    // 2. 获取设计师的外部联系人列表
    const contactsRes = await getExternalContacts(designerWxUserId);
    const contacts = contactsRes.data.externalContacts;
    
    // 3. 根据手机号匹配客户
    const customer = matchCustomer(contacts, customerPhone);
    if (!customer) {
      alert('未找到匹配的客户，请确认客户是否已添加为外部联系人');
      return;
    }
    
    // 4. 确认信息
    const confirmed = confirm(`
      确认创建客户群：
      客户：${customer.name}
      设计师：${designerWxUserId}
      项目经理：${projectManagerWxUserId}
    `);
    
    if (!confirmed) return;
    
    // 5. 创建群聊
    const groupName = `${customer.name}-服务群`;
    createCustomerGroup(
      [customer.externalUserId], // 外部联系人
      [designerWxUserId, projectManagerWxUserId], // 内部成员
      groupName
    );
    
  } catch (error) {
    console.error('创建客户群失败', error);
    alert('创建客户群失败：' + error.message);
  }
}
```

## 4. 后端流程实现（t1-code项目）

### 4.1 获取订单信息流程

**文件**：`codeFlow/订单相关/获取订单信息.js`

```javascript
// 根据订单ID获取订单信息
const order = await ctx.model.Order.findOne({
  where: { id: orderId },
  include: [
    { model: ctx.model.User, as: 'designer' }, // 设计师
    { model: ctx.model.User, as: 'projectManager' }, // 项目经理
    { model: ctx.model.Customer, as: 'customer' } // 客户
  ]
});

return {
  orderId: order.id,
  designerWxUserId: order.designer?.wxuserid,
  projectManagerWxUserId: order.projectManager?.wxuserid,
  customerPhone: order.customer?.phone
};
```

### 4.2 获取外部联系人列表流程

**文件**：`codeFlow/微信相关/获取外部联系人列表.js`

```javascript
// 调用企微API获取外部联系人列表
const access_token = await ctx.service.user.checkWxTokenV2();
const res = await ctx.curl(
  `https://qyapi.weixin.qq.com/cgi-bin/externalcontact/list?access_token=${access_token}&userid=${wxUserId}`,
  { dataType: 'json' }
);

// 获取每个外部联系人的详细信息
const externalUserIds = res.data.external_userid || [];
const contacts = await Promise.all(
  externalUserIds.map(async (externalUserId) => {
    const detailRes = await ctx.curl(
      `https://qyapi.weixin.qq.com/cgi-bin/externalcontact/get?access_token=${access_token}&external_userid=${externalUserId}`,
      { dataType: 'json' }
    );
    return {
      externalUserId: externalUserId,
      name: detailRes.data.external_contact?.name,
      phone: detailRes.data.external_contact?.mobile,
      avatar: detailRes.data.external_contact?.avatar
    };
  })
);

return { externalContacts: contacts };
```

### 4.3 创建客户群流程

**文件**：`codeFlow/微信相关/创建客户群.js`

```javascript
// 注意：企微不支持服务端直接创建客户群
// 需要通过JS-SDK在客户端创建
// 此流程用于记录群信息到数据库

const { orderId, chatId, groupName } = body;

// 记录群信息
await ctx.model.CustomerGroup.create({
  orderId: orderId,
  chatId: chatId,
  groupName: groupName,
  createdAt: new Date()
});

return {
  success: true,
  chatId: chatId,
  groupName: groupName
};
```

## 5. 注意事项

### 5.1 企微API限制

1. **客户群不能通过服务端API直接创建**
   - 必须通过JS-SDK在客户端创建
   - 服务端只能记录群信息

2. **外部联系人列表获取**
   - 需要应用有"客户联系"权限
   - 只能获取当前用户添加的外部联系人

3. **创建群聊权限**
   - 需要应用在"客户联系-可调用接口的应用"列表中
   - 当前用户需要有"客户联系"权限

### 5.2 数据匹配逻辑

1. **手机号匹配**
   - 需要处理手机号格式差异（带空格、带横线等）
   - 建议统一格式后再匹配

2. **客户未添加的情况**
   - 如果找不到匹配的客户，需要提示用户先添加客户为外部联系人

3. **多个匹配结果**
   - 如果手机号匹配到多个客户，需要让用户选择

### 5.3 错误处理

1. **设计师未添加客户**
   - 提示：该设计师尚未添加此客户为外部联系人

2. **权限不足**
   - 提示：当前用户没有客户联系权限

3. **创建群聊失败**
   - 记录错误日志
   - 提示用户重试

## 6. 开发检查清单

### 6.1 企微配置

- [ ] 配置JS-SDK可信域名
- [ ] 应用加入"客户联系-可调用接口的应用"
- [ ] 开通"客户联系"权限
- [ ] 确保用户有"客户联系"权限

### 6.2 后端接口

- [ ] 实现获取订单信息接口
- [ ] 实现获取外部联系人列表接口
- [ ] 实现记录群信息接口
- [ ] 添加错误处理和日志

### 6.3 前端页面

- [ ] 实现订单信息展示
- [ ] 实现客户匹配逻辑
- [ ] 实现创建群聊功能
- [ ] 添加加载状态和错误提示

### 6.4 测试

- [ ] 测试订单信息获取
- [ ] 测试外部联系人列表获取
- [ ] 测试客户匹配逻辑
- [ ] 测试创建群聊功能
- [ ] 测试错误处理

## 7. 相关文档

- [企微JS-SDK配置指南](../README_JS-SDK配置.md)
- [企微API文档](https://developer.work.weixin.qq.com/document/path/92525)
- [客户群进群方案说明](../../../docs/客户群进群方案说明.md)

## 8. 后续优化

1. **批量创建群聊**
   - 支持批量订单创建群聊

2. **群聊信息同步**
   - 定期同步群聊成员信息
   - 记录群聊消息统计

3. **自动化流程**
   - 订单创建后自动创建群聊
   - 客户进店后自动邀请入群

4. **权限管理**
   - 不同角色有不同的操作权限
   - 记录操作日志

