# 企微客户群创建 - 快速开始

## 需求概述

**业务场景**：客户到店后，将设计师、项目经理、客户自动拉入同一个企微群，便于后续服务管理。

**核心问题**：避免员工离职导致客户流失（客户群归企业所有）。

## 技术方案

使用企微JS-SDK在H5页面中创建客户群，流程如下：

```
H5页面 → 获取订单信息 → 获取设计师的外部联系人 → 匹配客户 → 创建群聊
```

## 开发步骤

### 1. 配置企微（必须）

参考：[README_JS-SDK配置.md](../README_JS-SDK配置.md)

- [ ] 配置JS-SDK可信域名（使用内网穿透）
- [ ] 应用加入"客户联系-可调用接口的应用"
- [ ] 开通"客户联系"权限

### 2. 后端接口开发（t1-code项目）

#### 2.1 获取订单信息

**流程文件**：`codeFlow/订单相关/获取订单信息.js`

**功能**：根据订单ID获取设计师、项目经理、客户手机号

#### 2.2 获取外部联系人列表

**流程文件**：`codeFlow/微信相关/获取外部联系人列表.js`

**功能**：获取指定设计师添加的所有外部联系人

#### 2.3 记录群信息

**流程文件**：`codeFlow/微信相关/记录客户群信息.js`

**功能**：创建群聊后，记录群ID等信息到数据库

### 3. 前端页面开发（dev-nest项目）

**页面文件**：`public/create-customer-group.html`

**功能**：
1. 接收订单ID参数
2. 调用后端接口获取订单信息和外部联系人
3. 根据手机号匹配客户
4. 使用JS-SDK创建群聊

### 4. 核心代码示例

```javascript
// 主流程
async function createGroup(orderId) {
  // 1. 获取订单信息
  const order = await getOrderInfo(orderId);
  
  // 2. 获取设计师的外部联系人
  const contacts = await getExternalContacts(order.designerWxUserId);
  
  // 3. 匹配客户
  const customer = contacts.find(c => c.phone === order.customerPhone);
  
  // 4. 创建群聊
  wx.invoke('openEnterpriseChat', {
    userlist: `${customer.externalUserId}|${order.designerWxUserId}|${order.projectManagerWxUserId}`,
    groupName: `${customer.name}-服务群`
  });
}
```

## 关键注意事项

1. **企微限制**：客户群不能通过服务端API直接创建，必须使用JS-SDK在客户端创建
2. **权限要求**：应用和用户都需要有"客户联系"权限
3. **域名要求**：必须配置可信域名，不能使用IP地址
4. **数据匹配**：需要处理手机号格式差异

## 详细文档

完整开发流程请参考：[企微客户群创建流程.md](./企微客户群创建流程.md)

