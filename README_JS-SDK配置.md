# 企微JS-SDK可信域名配置指南

## 问题说明

错误：`config:not match any reliable domain` (错误码 80001)

**原因**：企微JS-SDK不支持IP地址作为可信域名，必须使用域名。

## 官方文档

- **企微管理后台**：https://work.weixin.qq.com/
- **企微开发者文档**：https://developer.work.weixin.qq.com/
- **JS-SDK文档**：https://developer.work.weixin.qq.com/document/path/100746
- **错误码查询**：https://open.work.weixin.qq.com/devtool/query

## 解决方案

### 方案1：使用内网穿透工具（推荐）

#### 1. 安装并启动 ngrok

```bash
# 下载 ngrok: https://ngrok.com/download
# 注册账号获取 authtoken

# 启动 ngrok（假设你的 dev-nest 运行在 9009 端口）
ngrok http 9009
```

#### 2. 获取公网地址

ngrok 会生成类似这样的地址：

```
Forwarding: https://xxxx-xxxx-xxxx.ngrok.io -> http://localhost:9009
```

#### 3. 配置企微管理后台（详细步骤）

**官方文档参考**：[企业微信管理后台](https://work.weixin.qq.com/)

**配置步骤**：

1. **登录企微管理后台**
   - 访问：https://work.weixin.qq.com/
   - 使用管理员账号登录

2. **进入应用管理**
   - 在左侧导航栏中，点击 **应用管理**
   - 找到需要配置的**自建应用**，点击进入

3. **设置可信域名**
   - 在应用详情页面，找到 **网页授权及 JS-SDK** 部分
   - 点击 **设置可信域名** 或 **JS-SDK可信域名**
   - 输入域名：`xxxx-xxxx-xxxx.ngrok.io`（**不要包含协议头** `http://` 或 `https://`）
   - **注意**：不支持 IP 地址或短链域名

4. **域名校验（重要）**
   - 点击 **申请校验域名** 或 **验证域名**
   - 系统会提供一个校验文件（如 `WW_verify_xx.txt`）
   - **下载该校验文件**
   - 将校验文件上传至你的域名服务器的根目录
     - 对于 ngrok + dev-nest：将文件放在 `public` 目录下
     - 确保可以通过 `https://xxxx-xxxx-xxxx.ngrok.io/WW_verify_xx.txt` 访问
   - 返回企微管理后台，点击 **验证** 完成域名校验

5. **保存配置**
   - 验证成功后，保存配置
   - 等待 1-2 分钟让配置生效

**注意事项**：

- 域名不能包含协议头（`http://` 或 `https://`）
- 不支持 IP 地址
- 不支持短链域名
- 域名需要能够通过公网访问
- 校验文件必须能够通过 HTTPS 访问（生产环境）

#### 4. 访问页面

使用 ngrok 生成的地址访问：

```
https://xxxx-xxxx-xxxx.ngrok.io/public/wx-create-customer-chat.html
```

### 方案2：使用其他内网穿透工具

#### natapp（国内推荐）

1. 注册账号：https://natapp.cn
2. 下载客户端
3. 配置隧道（本地端口：9009）
4. 启动后获取域名（如：`xxxx.natapp1.cc`）
5. 在企微管理后台配置该域名

#### frp（自建服务器）

如果你有自己的服务器，可以使用 frp 搭建内网穿透。

### 方案3：使用已备案的域名（生产环境）

如果你有已备案的域名，可以：

1. 配置域名解析到你的服务器
2. 在企微管理后台配置该域名
3. 使用 HTTPS 访问（企微要求 HTTPS）

## 配置步骤详解

### 企微管理后台配置

1. **登录企微管理后台**
   - 地址：https://work.weixin.qq.com

2. **进入应用管理**
   - 路径：**应用管理** → **自建** → **你的应用**

3. **配置JS-SDK可信域名**
   - 找到 **JS-SDK可信域名** 或 **可信域名** 配置项
   - 点击 **设置** 或 **添加**
   - 输入域名（**不要包含协议和端口**）
     - ✅ 正确：`xxxx.ngrok.io`
     - ❌ 错误：`https://xxxx.ngrok.io`
     - ❌ 错误：`xxxx.ngrok.io:443`

4. **保存配置**
   - 配置后可能需要等待几分钟生效

5. **验证配置**
   - 刷新页面，重新测试
   - 如果还有错误，检查域名是否完全匹配（包括协议、端口、路径）

## 注意事项

1. **域名必须完全匹配**
   - 签名时使用的 URL 必须与配置的可信域名匹配
   - 例如：如果配置了 `xxxx.ngrok.io`，访问时必须是 `https://xxxx.ngrok.io/...`

2. **HTTPS 要求**
   - 生产环境必须使用 HTTPS
   - 本地开发可以使用 HTTP（但某些功能可能受限）

3. **域名格式**
   - 只能配置域名，不能配置 IP
   - 不能包含协议（http:// 或 https://）
   - 不能包含端口号

4. **配置生效时间**
   - 配置后可能需要等待 1-5 分钟生效
   - 如果立即测试失败，请等待几分钟后重试

## 权限配置（重要！）

### 问题：chooseExternalContact API 不可用

如果看到错误：`{"checkResult":{"chooseExternalContact":false},"errMsg":"checkJsApi:ok"}`

**原因**：应用或用户没有"客户联系"权限

### 解决步骤

#### 1. 开通客户联系功能

1. 登录企微管理后台：https://work.weixin.qq.com
2. 进入：**客户联系** → **配置**
3. 确保"客户联系"功能已开通

#### 2. 将应用加入"可调用接口的应用"

1. 进入：**客户联系** → **配置** → **API** 或 **应用管理**
2. 找到"可调用接口的应用"或"应用管理"
3. **将你的应用添加到列表中**（这是关键步骤！）
4. 确保应用有"选择客户"相关权限

#### 3. 检查用户权限

1. 进入：**客户联系** → **配置** → **成员与权限**
2. 确保**当前登录的用户**有"客户联系"权限
3. 确保用户有"选择客户"的权限

#### 4. 检查应用权限

1. 进入：**应用管理** → **你的应用** → **权限管理**
2. 确保应用已开通以下权限：
   - ✅ 客户联系
   - ✅ 选择客户（外部联系人）
   - ✅ 创建客户群

#### 5. 验证配置

配置完成后：

1. 等待 1-2 分钟让配置生效
2. 刷新页面重新测试
3. 如果还是不行，检查控制台是否有其他错误信息

## 测试步骤

1. 配置内网穿透，获取公网域名
2. 在企微管理后台配置该域名为可信域名
3. **配置客户联系权限**（见上方）
4. 使用公网域名访问页面
5. 检查 JS-SDK 初始化是否成功
6. 测试"选择客户"功能

## 常见问题

### Q: 为什么不能用 IP 地址？

A: 企微JS-SDK安全策略要求使用域名，不支持IP地址。

### Q: ngrok 地址每次都不一样怎么办？

A: 可以购买 ngrok 的付费版本，获得固定域名。或者使用其他提供固定域名的内网穿透服务。

### Q: 配置后还是报错？

A:

1. 检查域名是否完全匹配（包括协议、端口）
2. 等待几分钟让配置生效
3. 清除浏览器缓存后重试
4. 检查签名时使用的 URL 是否与访问的 URL 完全一致

### Q: chooseExternalContact 返回 false？

A:

1. **最重要**：检查应用是否在"客户联系-可调用接口的应用"列表中
2. 检查当前用户是否有"客户联系"权限
3. 检查应用是否开通了"客户联系"相关权限
4. 参考上面的"权限配置"章节

### Q: 本地开发必须用内网穿透吗？

A: 是的，企微JS-SDK要求配置可信域名，而IP地址不支持，所以必须使用域名（通过内网穿透获取）。
